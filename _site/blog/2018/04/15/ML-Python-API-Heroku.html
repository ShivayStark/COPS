<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta content="Building an AR Marker Detection program using ArUco Library" name="description"> <meta name="keywords" content="Jekyll,gh-pages,website,blog,easy"> <meta name="author" content="Club of Programmers"> <meta name="baseurl" content=""> <title> COPS IIT(BHU) | Creating an ML based Python API hosted on heroku </title> <!-- favicon --> <link rel="shortcut icon" href="/static/assets/img/favicon.ico"> <!-- Main CSS --> <link href="/static/assets/app-20190511.min.css" rel="stylesheet"> <link href="/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/static/assets/app-20190511.min.js"></script> <script src="/static/assets/blog-20190511.min.js"></script> <!-- Google AdSense --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184620190511", enable_page_level_ads: true }); </script> </head> <body id="page-top" class="landing-page"> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="http://localhost:4000/">COPS IIT(BHU)</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href="blog/"></a> </li> <li> <a class="page-scroll" href="http://localhost:4000/">Home</a></li> <li> <a class="page-scroll" href="http://localhost:4000/blog/">Blog</a></li> <li> <a class="page-scroll" href="http://localhost:4000/resources/potw/">POTW</a></li> <li> <a class="page-scroll" href="http://localhost:4000/resources/csoc2019/">CSOC</a></li> <li> <a class="page-scroll" href="http://localhost:4000/resources/extravaganza2019/">Dev Extravaganza</a></li> </ul> </div> </div> </nav> </div> <div id="particles-js"></div> <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js" defer></script> <script type="text/javascript" src="http://localhost:4000/particles.js" defer></script> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/blog">Blog</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 15 Apr 2018</span> <h1> Creating an ML based Python API hosted on heroku </h1> </div> <h1 id="creating-an-ml-based-python-api-hosted-on-heroku">Creating an ML based Python API hosted on Heroku</h1> <p>Since long I’ve been thinking of creating an API which fellow developers could use over cloud. But I didn’t want it to be the traditional <a href="https://github.com/shubhamvadhera/hello-world-rest">Hello World API</a> or <a href="https://medium.com/python-pandemonium/build-simple-restful-api-with-python-and-flask-part-1-fae9ff66a706">simple SQL Flask API</a>  —  supporting the classical user name and email ID GET, PUT, POST, DELETE REST requests. Since AI and ML are so pervasive now, I thought of giving ML a try — and it is easy : )</p> <h2 id="image-classification-using-pytorch">Image Classification using PyTorch</h2> <p><img src="https://cdn-images-1.medium.com/max/800/1*t6hCM90evdnlPw4l9VK3AQ.png" alt="PyTorch Logo" /></p> <p>Since everything’s on the cloud and the free versions I needed an AI/ML project with small, lightweight dependencies for the cloud. I forked a project named <a href="https://github.com/christiansafka/img2vec">Img2vec</a> that uses PyTorch to generate feature vectors for a dataset of images and then does a simple match(<a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.pairwise.cosine_similarity.html">cosine similarity</a> in <strong>sklearn</strong>) of a test image with others using pretrained models. The readme provides enough snippets to make the demo work on your system.</p> <h2 id="training-the-image-data-set">Training the image data set</h2> <p>For the sake of simplicity, I’m skipping the data set training part — there are lot of docs over the internet. For our API purpose, I’m generating image vectors and storing them as <strong>csv</strong> files. Since computations will happen over cloud, if we generate vectors on runtime, the API will always timeout. But the API will generate vector for the image data you’ll ping and read other vectors from csv files.</p> <h2 id="setting-up-the-flask-app">Setting up the Flask app</h2> <p><img src="https://cdn-images-1.medium.com/max/800/1*H3aEP7X3hd7wVCigrF3O1Q.png" alt="Flask Logo" /></p> <p>For a simple image match, I needed a POST or PUT request. There are many frameworks that support REST features, I used flask on Python 3.6. As the official site reads</p> <blockquote> <p>Flask is a lightweight WSGI web application framework. It is designed to make getting started quick and easy</p> </blockquote> <p>So here’s the idea:</p> <ul> <li>The server receives an image as byte stream</li> <li>Those bytes are encoded back to an image using <a href="https://pillow.readthedocs.io/en/5.1.x/">Pillow</a> in Python</li> <li>A feature vector is generated for that image</li> <li>That vector is matched against the training data images</li> <li>Closest matching images are returned back (with a download URL and a percentage match value)</li> </ul> <p>Here’s the gist of the API :</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># endpoint to detect image
</span><span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/image_clustering"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"PUT"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">image_clustering</span><span class="p">():</span>

    <span class="c1"># Image converted in Base64 encoded byte stream
</span>    <span class="nb">bytes</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>  <span class="c1"># returns a list of image matches
</span>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</code></pre></div></div> <p><strong>Note</strong>: The test Image posted is not normal byte stream, its base64 encoded image byte stream — a standard way to ship <a href="https://stackoverflow.com/questions/201479/what-is-base-64-encoding-used-for">binary data across networks</a>.</p> <p><strong>Note</strong>: Get the source <a href="https://github.com/AKS1996/k-means-clustering-api">code here</a>.</p> <h2 id="setting-up-the-heroku-server">Setting up the Heroku server</h2> <p><img src="https://cdn-images-1.medium.com/max/800/1*w2RAR48UbSAYv-6y_V-cdA.png" alt="Heroku Logo" /></p> <p>Setting up the server is pretty straight forward, but there are a few issues I encountered:</p> <ul> <li><strong>Slug Size</strong>: Heroku provides a max slug size of 500 MB, the total data an app can hold(code, executables, and media files like images, pdfs) after compression. This is an issue since python libraries like SciPy and PyTorch are pretty hefty in size — PyTorch with CUDA 8 is ~600MB alone. But there are workarounds.</li> <li><strong>PyTorch Version</strong>: PyTorch provides a CPU only build variant, a small 45 MB library providing all the features we need for deployment.</li> <li><strong>SciPy Manual Install</strong>: Don’t know why, but an online install of SciPy on Heroku turns out to be buggy(more of it <a href="https://stackoverflow.com/a/37648960/8243704">here</a>. Instead I downloaded the SciPy whl(or the source code) as a file and manually installed it on the server.</li> <li><strong>JPEG vs PNG</strong>: In the demo code, I’ve used JPEG extension files(with base64 encoded data beginning from /9j/9…). So if you ping the server with images in other formats like PNG(base64 encoded data starts with iVi…) you will get an error.</li> </ul> <h2 id="demo-time">Demo Time</h2> <p>You can take a demo in many ways</p> <ul> <li>You can install an app(<a href="https://github.com/AKS1996/k-means-clustering-api/blob/master/ImageMatch.apk">get it here</a>) on your android device. Click an image it’ll take some time and will display the closest matching images.</li> <li>You can use <a href="https://github.com/AKS1996/k-means-clustering-api/blob/master/sample_python_script.py">this python script</a>. Just enter the relative path of the image on your desktop and it will display the results</li> <li>You can make a PUT request online(I recommend <a href="https://www.hurl.it/">Hurl.it</a> for starters) to <a href="http://beard-app.herokuapp.com/image_clustering">this URL</a> with base64 encoded image data as body.</li> </ul> <p>For the sample cat image shown, the results are</p> <p><img src="https://cdn-images-1.medium.com/max/800/1*Bo-R0IHSwuCVQOceaS9X1Q.jpeg" alt="cat" /></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">[</span><span class="w">
    </span><span class="mf">0.8155140106062471</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"https://www.googleapis.com/download/storage/v1/b/python-clustering-api.appspot.com/o/images%2FFace%2F124.jpg?generation=1522585329188523&amp;alt=media"</span><span class="w">
  </span><span class="p">],</span><span class="w"> 
  </span><span class="p">[</span><span class="w">
    </span><span class="mf">0.8145577585207011</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"https://www.googleapis.com/download/storage/v1/b/python-clustering-api.appspot.com/o/images%2FFace%2F242.jpg?generation=1522585299229997&amp;alt=media"</span><span class="w">
  </span><span class="p">],</span><span class="w"> 
  </span><span class="p">[</span><span class="w">
    </span><span class="mf">0.7914929138145477</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"https://www.googleapis.com/download/storage/v1/b/python-clustering-api.appspot.com/o/images%2FFace%2F212.jpg?generation=1522584727478100&amp;alt=media"</span><span class="w">
  </span><span class="p">],</span><span class="w"> 
  </span><span class="p">[</span><span class="w">
    </span><span class="mf">0.7806927914191767</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"https://www.googleapis.com/download/storage/v1/b/python-clustering-api.appspot.com/o/images%2FFace%2F099.jpg?generation=1522585251917855&amp;alt=media"</span><span class="w">
  </span><span class="p">],</span><span class="w"> 
  </span><span class="p">[</span><span class="w">
    </span><span class="mf">0.6948463995381056</span><span class="p">,</span><span class="w"> 
    </span><span class="s2">"https://www.googleapis.com/download/storage/v1/b/python-clustering-api.appspot.com/o/images%2FFace%2F119.jpg?generation=1522584693369035&amp;alt=media"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <p>If the article helped you, <strong>please comment below</strong>. Feel free to ask if faced any problems reading the article.</p> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">PyTorch</button> <button class="btn btn-white btn-xs" type="button">Flask</button> <button class="btn btn-white btn-xs" type="button">Heroku</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> <i class="fa fa-comments-o"> </i> <span class="disqus-comment-count" data-disqus-url="http://localhost:4000/blog/2018/04/15/ML-Python-API-Heroku.html">0</span> comments </div> </div> </div> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> <div id="disqus_thread"></div> <script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */ /* var disqus_config = function () { this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { var d = document, s = d.createElement('script'); s.src = '//iitbhu-cops.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> </div> </div> <!-- Google analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-128283984-1', 'auto'); ga('require', ''); ga('send', 'pageview'); </script> <!-- GrowingIO --> <div class="github-ribbon"> <a href="https://github.com/COPS-IITBHU/cops-website" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; z-index: 9999; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"> <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path> <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path> <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path> </svg></a> <style> @media screen and (max-width: 768px) { .github-ribbon { display: none; } } .github-corner:hover .octo-arm { animation: octocat-wave 560ms ease-in-out } @keyframes octocat-wave { 0%, 100% { transform: rotate(0) } 20%, 60% { transform: rotate(-25deg) } 40%, 80% { transform: rotate(10deg) } } @media (max-width:500px) { .github-corner:hover .octo-arm { animation: none } .github-corner .octo-arm { animation: octocat-wave 560ms ease-in-out } } </style> </div> </body> </html>
